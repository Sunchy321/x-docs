%!TEX root = x.tex

\rSec0[expr]{表达式}
\indextext{表达式}

\begin{bnf}
\nontermdef{Expression} \br
    PrimaryExpr \br
    Operator Expression \br
    Expression Operator \br
    Expression Operator Expression \br
\end{bnf}

\pnum
\term{表达式}由\term{运算符}与操作数按照顺序组合在一起，它表示一个计算过程。运算符是若干标点符号的组合、一个标识符或是语言规定的特殊结构。运算符可以是前缀、后缀或者是中缀的，这决定了运算符与其操作数的结合方式。运算符组是运算符的集合，每一个运算符都属于某个运算符组。运算符组之间有一个弱偏序关系，决定了它们的\term{优先级}。完全由中缀运算符构成的运算符组有\term{结合性}：左结合的组每个运算符从左到右选择操作数；右结合的组从右到左；无结合的组两个运算符不能选择同一个操作数。

\pnum
\ref{expr.suffix} 到 \ref{expr.semi} 各节按照优先级从高到低依次对运算符组进行描述。若无特别说明，每一节描述一个运算符组。

\pnum
解析表达式按照如下顺序：

\begin{itemize}
\item 构造基本表达式、运算符和 ID 表达式。
\item 将 \tcode{.} 和后面的 ID 表达式结合为一个后缀运算符。
\item 将每个重载为运算符的标识符\footnote{这里指本身作为 ID 表达式的而不是作为 ID 表达式的一部分的标识符。}替换为运算符。
\item 对于每组连续的基本表达式，如果除了第一个以外都形如 \tcode{(...)}、\tcode{[...]} 或 \tcode{\{...\}}，将它们替换为后缀运算符；否则这是一个编译错误。\enternote 因为块也是基本表达式，它也会被替换为后缀运算符。然后如果有的话，它会与之前的函数调用运算符结合成一个函数调用运算符。\exitnote
\item 确定每个运算符是前缀、后缀或中缀的。对于每组连续的运算符，如果存在一个运算符满足：
\begin{itemize}
    \item 它要么是 \tcode{;} 要么两边都有空白；
    \item 它可以作为中缀运算符；
    \item 它前面的所有运算符都可以作为后缀运算符；\enternote 由上文已经限定为前缀运算符的运算符在这里不能作为后缀运算符；反之亦然 \exitnote
    \item 它后面的所有运算符都可以作为前缀运算符。
\end{itemize}
那么这个运算符是中缀运算符，这个运算符之前的所有运算符是后缀运算符，这个运算符之后的所有运算符是前缀运算符。如果存在多于一个或者不存在这样的运算符，这是一个编译错误。
\item 运算符按照优先级选择操作数。对于优先级最高（可能不止一个）的运算符组：
\begin{itemize}
    \item 每个运算符选择各自的操作数。如果不同的组之间选择了相同的操作数，这是一个编译错误。如果选择的表达式不是基本表达式也不是优先级高于这个运算符组的运算符构成的表达式，这是一个编译错误。
    \item 如果这个组由前缀、中缀和后缀混合而成或是无结合的中缀运算符组，选择相同的操作数的运算符引发一个错误；
    \item 如果这个组是前缀组或者是右结合的中缀组，每个运算符从右到左把自己和操作数替换为一个子表达式；
    \item 如果这个组是后缀组或者是左结合的中缀组，每个运算符从左到右把自己和操作数替换为一个子表达式。
\end{itemize}
\item 如果最后仍然剩余大于一个子表达式，这是一个编译错误。
\end{itemize}

$$ \mathrm{\rhd}: \mathcal{E} \times \Omega \rightarrow (\mathcal{V} \cup \mathcal{V}^\dag \cup \{\ast\}) \times \Omega $$

\indextext{求值}
\pnum
$\mathrm{e \rhd \omega}$ 称作\term{在环境 $\omega$ 下对 $e$ 求值}。设 $\mathrm{e \rhd \omega} = \langle v, \omega^\prime \rangle$。如果 $v \in \mathcal{V}$，称\term{求值正常结束}，$v$ 是 $e$ 的\term{值}；否则，称\term{求值以抛出 $v$ 异常结束}，$e$ 的值为 \tcode{never()}。$v = \ast$ 意味着求值过程中程序终止了。若无特别说明，对表达式 $e$ 的子表达式 $e_0$ 求值以抛出 $v$ 异常结束也会导致对 $e$ 的求值以抛出 $v$ 异常结束。

\pnum
$\omega$ 是求值之前的环境，$\omega^\prime$ 是求值之后的环境。如果 $\omega = \omega^\prime$，称 $e$ 是\term{无副作用}的；如果 $e$ 是无副作用的且 $v$ 与 $\omega$ 无关，称 $e$ 是\term{纯}的。

\pnum
下文的数学定义式中，$\coloneqq$ 右边的 $e$ 表示对 $e$ 求值之后的 $v$；$\otimes e$ 表示求值后的环境；$\rhd e$ 表示求值的结果。如果表达式是无副作用的，将 $\omega$ 部分省略。

\pnum
\term{丢弃表达式 $e$ 的结果}指，在决定 $e$ 的类型时，直接将它确定为 \tcode{never} 而跳过所有步骤；在对 $e$ 求值时，进行所有步骤，但是如果求值正常结束，丢弃最后的值。

\rSec1[expr.primary]{基本表达式}
\indextext{表达式!基本}

\begin{bnf}
\nontermdef{PrimaryExpr} \br
    LiteralExpression \br
    Identifier \br
    \terminal{(} Expression \terminal{)} \br
    LambdaExpr
\end{bnf}

$$ \tcode{(}e\tcode{)} \rhd \omega \coloneqq e \rhd \omega $$

\pnum
括号包起的表达式与其内部的表达式完全等价。

\rSec2[expr.lit]{字面量表达式}
\indextext{表达式!字面量}

\begin{bnf}
\nontermdef{LiteralExpression} \br
    IntegerLiteral \br
    FloatLiteral \br
    StringLiteral \br
    \terminal{true} \br
    \terminal{false} \br
    \terminal{nil}
\end{bnf}

\pnum
字面量本身是基本表达式。

\pnum
整数字面量$i$的值为$i$，类型为$\tcode{int}_i$。如果$i$超出了能够选择的范围，这是一个编译错误。

\pnum
浮点字面量$f$的值为最接近$f$的浮点数值，类型为\tcode{float}。如果$f$太大，则其值为\tcode{float.Infinity}；如果$f$太小，其值为\tcode{0}。

\pnum
字符串字面量$s$的值为对应的字符串，类型为\tcode{string}。

\pnum
布尔字面量的类型为\tcode{bool}。\tcode{true}和\tcode{false}分别对应其值。

\pnum
\tcode{nil}的类型为$T$\tcode{?}，其中$T$为待推导的类型参数。

\rSec2[expr.lambda]{Lambda表达式}
\indextext{表达式!Lambda}

\begin{bnf}
\nontermdef{LambdaExpr} \br
    SimpleLambdaExpr \br
    CompoundLambdaExpr
\end{bnf}

\begin{bnf}
\nontermdef{SimpleLambdaExpr} \br
    LambdaParameter\bnfq\ \terminal{=>} LambdaBody
\end{bnf}

\begin{bnf}
\nontermdef{LambdaParameter} \br
\end{bnf}

\rSec1[expr.suffix]{后缀运算符}

\rSec1[expr.add]{加法运算符}

\pnum
运算符 \tcode{+} 和 \tcode{-} 分别表示加法和减法。

\rSec1[expr.toplvl]{顶层运算符}

\pnum
顶层运算符的结果类型都是 \tcode{void}。

\rSec1[expr.semi]{分号运算符}
\indextext{运算符!分号}

\begin{bnf}
\nontermdef{SemicolonExpression}\br
    Expression \terminal{;} Expression\br
    SimplDeclaration \terminal{;} Expression\br
\end{bnf}

$$ x \mathbin{\tcode{;}} y \rhd \omega \coloneqq y \rhd \otimes \mathrm{discard}(x)$$

\pnum
分号表达式中，分号左侧可以为一个表达式或声明。如果分号左侧为声明，则该声明会被插入到当前作用域中。如果左侧为表达式，则该表达式将被求值且结果会被丢弃。在那之后，将对右侧表达式进行求值并将其值作为整个表达式的值。